image: ubuntu:18.04
services:
    - docker:dind

stages:
    - build
    - test

before_script:
    - apt-get update
    - apt install -y curl
    # docker installing
    - curl -fsSL https://get.docker.com -o get-docker.sh
    - sh get-docker.sh
    # login to gitlab
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY

build:
    stage: build
    before_script:
      - apt-get update
      - apt install -y curl
      # docker installing
      - curl -fsSL https://get.docker.com -o get-docker.sh
      - sh get-docker.sh
    script:
      - docker build -t smart-ad .

test:
    stage: test
    before_script:
        - apt-get update
        - apt-get -y install python3-pip
        - apt-get -y install python3-psycopg2
        - apt-get install -y python-lasagne
        - pip3 install -r requirements.txt
        - usermod -aG docker ${$CI_BUILD_TOKEN}
    script:
        - pytest tests.py